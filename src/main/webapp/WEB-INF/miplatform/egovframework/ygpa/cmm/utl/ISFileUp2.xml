<?xml version="1.0" encoding="utf-8"?>
<Window>
	<Form Height="300" Id="ISFileUp" Left="8" OnTimer="ISFileUp_OnTimer" PidAttrib="7" TooltipFont=",0" Top="8" Ver="1.0" Width="400" WorkArea="true">
		<Datasets>
			<Dataset DataSetType="Dataset" FireNextCount="10" Id="Dataset0">
				<Contents>
					<colinfo id="filename" size="256" summ="default" type="STRING"/>
				</Contents>
			</Dataset>
		</Datasets>
		<CyHttpFile Height="24" Id="CyHttpFile0" Left="79" Top="247" Width="24"></CyHttpFile>
		<FileDialog Bottom="274" Height="24" Id="FileDlg" Left="55" MultiSelect="TRUE" Right="79" TabOrder="6" Top="250" Width="24"></FileDialog>
		<Image Align="Left" Height="50" Id="Image2" ImageID="pop_title_bg" TabOrder="1" Width="400"></Image>
		<Static Color="user6" Height="16" Id="Static6" Left="27" Style="C_lblTitle" TabOrder="3" Text="파일업로드" Top="20" Width="200"></Static>
		<Image Height="15" Id="Image3" ImageID="bu02" Left="15" TabOrder="2" Top="18" Width="8"></Image>
		<Grid AutoFit="TRUE" BindDataset="Dataset0" BkColor2="default" BkSelColor="user17" BoldHead="true" Border="Flat" BorderColor="user5" Bottom="285" Color="user0" Editable="TRUE" Enable="true" EndLineColor="default" HeadHeight="19" Height="200" Id="grdList" InputPanel="FALSE" Left="15" LineColor="default" MinWidth="100" Right="385" SelColor="user20" TabOrder="4" TabStop="true" Top="85" UseDBuff="true" UsePopupMenu="true" UseSelColor="true" Visible="true" VLineColor="default" WheelScrollRow="1" Width="370">
			<contents>
				<format id="Default">
					<columns>
						<col fix="left" width="370"/>
					</columns>
					<head>
						<cell bkcolor="user10" col="0" color="user12" display="text" text="File&#32;Name"/>
					</head>
					<body>
						<cell bkcolor="user6" bkcolor2="user4" col="0" colid="filename" display="text"/>
					</body>
				</format>
			</contents>
		</Grid>
		<Button ButtonStyle="TRUE" Color="user0" Font="돋움,9" Height="18" Id="btnSave" ImageID="btn_02_4" Left="315" OnClick="btnSave_OnClick" TabOrder="5" Text="파일저장" Top="60" Width="72"></Button>
		<Button ButtonStyle="TRUE" Color="user0" Font="돋움,9" Height="18" Id="btnSearch" ImageID="btn_02_4" Left="235" OnClick="btnSearch_OnClick" TabOrder="6" Text="파일선택" Top="60" Width="72"></Button>
		<Image Height="11" Id="ImgClose" ImageID="btn_close" Left="341" OnClick="ImgClose_OnClick" Static="FALSE" TabOrder="7" Top="19" Width="44"></Image>
	</Form>
	<Script><![CDATA[#include "lib::common.js";


function btnSearch_OnClick(obj)
{
	if(!FileDlg.Open()) return;
	var strFileName = FileDlg.FilePath + "\\"; 
	array = FileDlg.FileNameList;

	for( i=0; i<array.length; i++ ){
		Dataset0.addRow();
		Dataset0.SetColumn(Dataset0.row,"filename",strFileName + "\\" + array[i]);
	}	
}

function btnSave_OnClick(obj)
{
	gfn_showProg(this,"파일저장중.");
	
	SetTimer(1,1000);
	

}


function ISFileUp_OnTimer(obj,nEventID)
{
	KillTimer(1); //Timer설정을 Kill시킨다.
	CyHttpFile0.MultiInit(); // 시작전에 초기화 처리

	//alert(Dataset0.SaveXML("","",true,"utf-8"));
	// 폼변수 전송
	CyHttpFile0.MultiAddArguments("saveproperty", "file.upload.path", false); // 폼변수:false
	// 데이터셋 넘기기
	CyHttpFile0.MultiAddArguments("xmldata", UrlEncode(Dataset0.SaveXML()), false); // 폼변수:false
	CyHttpFile0.MultiAddArguments("kortest", UrlEncode("한글 테스트"), false); // 폼변수:false
	
	// 파일 업로드
	//objHttpFIle.MultiAddArguments("file1", strFileFullName, true);
    //strFileFullName 값은 로칼 파일 경로 + 파일명 이고 마지막 Argument가 True임	
	for( i=0; i<Dataset0.rowcount; i++ )
	{
		//trace(UrlEncode(Dataset0.GetColumn(i,"filename")));
		CyHttpFile0.MultiAddArguments("upfile", Dataset0.GetColumn(i,"filename"),true); //파일:true
	}

	//var rtn = CyHttpFile0.MultiRequest("http://localhost:8095/Test_1/HttpMultiPart.jsp");
	//var rtn = CyHttpFile0.MultiRequest("svc::/ipa/sym/cmm/zip/ISCcmExcelZipRegist.do");
	var rtn = CyHttpFile0.MultiRequest(G_Server + "/ISFileUp2.do");
	
	//trace(CyHttpFile0.ErrorMsg);
	
	var ErrorCode="";
	var ErrorMsg="";
	//호출 성공 여부 
	if ( rtn == 1 ){
		// 서버의 성공/실패 결과값을 받고싶으면 ErrorMsg로 전송받아 처리한다.
		//alert("rtn == 1 , "+ CyHttpFile0.ErrorMsg);
		//alert("에러 메시지 ::"+CyHttpFile0.ErrorMsg);
		//alert(CyHttpFile0.StatCode);
		
		
		var XMLDoc = CreateObject("Microsoft.XMLDOM");
		XMLDoc.async = false;
		XMLDoc.loadxml(CyHttpFile0.ErrorMsg);
	
		var root = XMLDoc.documentElement;
	
		var nodeList = root.getElementsByTagName("params");
		
		for(var j=0;j<nodeList.length;j++)
		{	
			var node = nodeList[j];
			
			var childNodes = node.childNodes;
			
			for(var i=0; i < childNodes.length; i++)
			{
				var strTmp = childNodes[i].text;
				if(strTmp == null) strTmp = "";
				
				if ( "ErrorCode" == childNodes[i].getAttribute("id") ) ErrorCode = strTmp;
				if ( "ErrorMsg" == childNodes[i].getAttribute("id") ) ErrorMsg = strTmp;
	
			}
			
			destroyObject(childNodes);
			destroyObject(node);
	
		}
		destroyObject(nodeList);
		destroyObject(root);
		destroyObject(XMLDoc);
		
		fnTrans(ErrorMsg);
		
		gfn_hideProg(this);
		gfn_Message("0","파일 저장을 성공했습니다.");
		//SetTimer(1,1000);
		ImgClose_OnClick();		
	}
	else{

		gfn_hideProg(this);
		gfn_Message("-1","파일 저장을 실패했습니다.");

	} 
		
	
}

function ImgClose_OnClick(obj,nX,nY)
{
	close();
}


function fnTrans(ErrorMsg)
{
	if(isValidObject(parent.txtFileResult)) parent.txtFileResult.Text = ErrorMsg;
	if(isValidObject(parent.ds_file)) {

		var arrMsgs = split(ErrorMsg,"*");
		for(var i=0; i<length(arrMsgs); i++)
		{
		
			var arrDatas = split(arrMsgs[i],"^");

			parent.ds_file.addrow();
			parent.ds_file.setcolumn(ds_file.row, "filePath", arrDatas[0]);
			parent.ds_file.setcolumn(ds_file.row, "fileSize", arrDatas[1]);
			parent.ds_file.setcolumn(ds_file.row, "originalFileName", arrDatas[2]);
			parent.ds_file.setcolumn(ds_file.row, "uploadFileName", arrDatas[3]);
			parent.ds_file.setcolumn(ds_file.row, "fileExtension", arrDatas[4]);
					
			//trace(arrDatas[2]);
		}
				

	}
}]]></Script>
</Window>