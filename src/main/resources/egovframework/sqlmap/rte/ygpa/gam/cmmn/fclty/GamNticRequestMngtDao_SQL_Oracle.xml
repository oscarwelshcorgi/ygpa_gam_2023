<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="rte.ygpa.gam.cmmn.fclty">

  <typeAlias  alias="egovMap" type="egovframework.rte.psl.dataaccess.util.EgovMap"/>
  <typeAlias alias="hashMap" type="java.util.HashMap"/>

  <select id="gamNticRequestMngtDAO.selectLevRequestByPk_S" parameterClass="hashMap" resultClass="egovMap">
    SELECT
      NTIC_CNT,
      PRT_AT_CODE,
      MNG_YEAR,
      MNG_NO,
      MNG_CNT,
      CHRGE_KND,
      FCLTY_SE,
      ENTRPSCD,
      ENTRPS_NM,
      NTIC_PD_FROM,
      NTIC_PD_TO,
      ACCNUT_YEAR,
      NTICNO,
      NTIC_DT,
      PAY_TMLMT,
      SANCTN_STTUS,
      SANCTNER_EMPL_NO,
      SANCTN_DT,
      OLNLP,
      FEE,
      VAT_YN,
      VAT,
      NTIC_AMT,
      RM,
      RCIV_SE,
      RCIV_DT,
      NHT_ISUE_YN,
      ARRRG_NO,
      ARRRG_AMT,
      REQEST_SEQ,
      DEPTCD,
      NTIC_MTH,
      NHT_PRINT_YN,
      REG_USR,
      REGIST_DT,
      UPD_USR,
      UPDT_DT
      FROM LEV_REQEST_PD_BY_STATS_F
      WHERE  PRT_AT_CODE=#prtAtCode#
        AND MNG_YEAR=#mngYear#
        AND MNG_NO=#mngNo#
        AND MNG_CNT=#mngCnt#
        AND NTIC_CNT=#nticCnt#
        AND CHRGE_KND=#chrgeKnd#
  </select>

  <select id="gamNticRequestMngtDAO.selectLevRequestList_D" parameterClass="hashMap" resultClass="egovMap">
    SELECT
      NTIC_CNT,
      PRT_AT_CODE,
      MNG_YEAR,
      MNG_NO,
      MNG_CNT,
      CHRGE_KND,
      FCLTY_SE,
      ENTRPSCD,
      ENTRPS_NM,
      NTIC_PD_FROM,
      NTIC_PD_TO,
      ACCNUT_YEAR,
      NTICNO,
      NTIC_DT,
      PAY_TMLMT,
      SANCTN_STTUS,
      SANCTNER_EMPL_NO,
      SANCTN_DT,
      OLNLP,
      FEE,
      VAT_YN,
      VAT,
      NTIC_AMT,
      RM,
      RCIV_SE,
      RCIV_DT,
      NHT_ISUE_YN,
      ARRRG_NO,
      ARRRG_AMT,
      REQEST_SEQ,
      DEPTCD,
      NTIC_MTH,
      NHT_PRINT_YN,
      REG_USR,
      REGIST_DT,
      UPD_USR,
      UPDT_DT
      FROM LEV_REQEST_PD_BY_STATS_F
      WHERE  PRT_AT_CODE=#prtAtCode#
        AND MNG_YEAR=#mngYear#
        AND MNG_NO=#mngNo#
        AND MNG_CNT=#mngCnt#
        AND NTIC_CNT=#nticCnt#
        <isNotEmpty prepend="AND" property="chrgeKnd">
          CHRGE_KND=#chrgeKnd#
        </isNotEmpty>
  </select>

    <insert id="gamNticRequestMngtDAO.insertNticRequestRevCollF" parameterClass="hashMap" >
        INSERT INTO PAYEOSU.REV_COLL_F@YGPA_P2MGR (
      PRT_AT_CODE, FEE_TP, FISCAL_YR, BILL_NO,
      AGENT_CODE, BZ_RGST_ID, AGENT_NAME, SSN,
      BILL_DT, DUE_DATE, BILL_PRT_YN,
      BILL_AMNT, EXMP_AMNT, OVER_AMNT, DC_AMNT,
		RCVD_TP,
      UPDT_UID, UPDT_DATE, FIRST_BILL_DT, VAT_YN, VAT, STR_DATE, END_DATE,
      DEPT
      )
        SELECT
      PRT_AT_CODE, CHRGE_KND FEE_TP, #accnutYear# FISCAL_YR, #nticno# BILL_NO,
      ENTRPSCD, (SELECT BZ_RGST_ID FROM P2MGR.SHP_OWOP_F@YGPA_P2MGR WHERE AGENT_CODE=ENTRPSCD) BZ_RGST_ID, (SELECT FIRM_KOR_NM FROM P2MGR.SHP_OWOP_F@YGPA_P2MGR WHERE AGENT_CODE=ENTRPSCD) AGENT_NAME,(SELECT SSN FROM P2MGR.SHP_OWOP_F@YGPA_P2MGR WHERE AGENT_CODE=ENTRPSCD) SSN,
      SYSDATE, TO_DATE(#payTmlmt#, 'YYYY-MM-DD'), NHT_PRINT_YN,
      NTIC_AMT, RDCXPT_FEE, 0, 0,
		'0',
      #updUsr#, SYSDATE, SYSDATE, VAT_YN, VAT, NTIC_PD_FROM, NTIC_PD_TO,
      #deptCd#
      FROM LEV_REQEST_F
      WHERE PRT_AT_CODE=#prtAtCode#
      	AND MNG_YEAR=#mngYear#
      	AND MNG_NO=#mngNo#
      	AND MNG_CNT=#mngCnt#
      	AND NTIC_CNT=#nticCnt#
    </insert>

    <insert id="gamNticRequestMngtDAO.insertNticRequestRevCollFC1" parameterClass="hashMap" >
        INSERT INTO PAYEOSU.UNPAID_F@YGPA_PORTMIS (
      PRT_AT_CODE, FEE_TP, FISCAL_YR, BILL_NO,
      DLY_SER_NO, DLY_BILL_AMNT, DLY_BILL_DT, DLY_DUE_DT, DLY_RCVD_DT, DLY_BILL_PRT_YN, DLY_RCVD_TP,
      FIRST_BILL_DT, DBILL_AMNT,
      BZ_RGST_ID, DLY_BILL_RSN,UPDT_UID,UPDT_DATE, AGENT_CODE,
      ACCNT_CODE,ICHE_STATUS,POST_BILL_YN,STR_DATE,END_DATE,
      DEPT
      )
      SELECT
              L.PRT_AT_CODE, L.CHRGE_KND, L.ACCNUT_YEAR, L.NTICNO,
      (SELECT LPAD(NVL(MAX(DLY_SER_NO), 0)+1, 2, '0') FROM UNPAID_F@YGPA_PORTMIS WHERE PRT_AT_CODE=L.PRT_AT_CODE
      	AND FEE_TP=L.CHRGE_KND AND FISCAL_YR=L.ACCNUT_YEAR AND BILL_NO=L.NTICNO) DLY_BILL_NO,
      	L.ARRRG_AMT, SYSDATE, TO_DATE(#newPayTmlmt#, 'YYYY-MM-DD') PAY_TMLMT, null, 'N', '1',
      	L.NTIC_DT, L.ARRRG_AMT,
      	(SELECT BZ_RGST_ID FROM P2MGR.SHP_OWOP_F@YGPA_P2MGR WHERE AGENT_CODE=L.ENTRPSCD),
      	'(' || TO_CHAR(L.NTIC_AMT, '999,999,999,999') || '*' || TO_CHAR(L.ARRRG_TARIFF, '999,999,999,999') || '*' || TO_CHAR(L.ARRRG_PAY_DATES,'9,999') || '/365' || ')',
      	#updUSr#, SYSDATE, L.ENTRPSCD, '194', 'N', 'N',TO_CHAR(L.NTIC_PD_FROM,'YYYYMMDD'),TO_CHAR(L.NTIC_PD_TO,'YYYYMMDD'),
      	#deptCd#
      FROM LEV_REQEST_F L
      WHERE PRT_AT_CODE=#prtAtCode#
      	AND MNG_YEAR=#mngYear#
      	AND MNG_NO=#mngNo#
      	AND MNG_CNT=#mngCnt#
      	AND NTIC_CNT=#nticCnt#
    </insert>

    <delete id="gamNticRequestMngtDAO.removeNticRequestRevCollFC1" parameterClass="hashMap" >
            DELETE FROM PAYEOSU.UNPAID_F@YGPA_PORTMIS WHERE FEE_TP='C1' AND (PRT_AT_CODE, FISCAL_YR, BILL_NO) IN
     (
     	SELECT
              PRT_AT_CODE, ACCNUT_YEAR, NTICNO
		FROM LEV_REQEST_F
      	WHERE PRT_AT_CODE=#prtAtCode#
	      	AND MNG_YEAR=#mngYear#
	      	AND MNG_NO=#mngNo#
	      	AND MNG_CNT=#mngCnt#
	      	AND NTIC_CNT=#nticCnt#
      	)
    </delete>

      <select id="gamNticRequestMngtDAO.selectNticNoAccnutYear_S" parameterClass="hashMap" resultClass="egovMap">
		SELECT LPAD(NVL(MAX(BILL_NO), 0) + 1, 6, '0') NTICNO,
		       TO_CHAR(SYSDATE, 'YYYY') ACCNUT_YEAR
		FROM PAYEOSU.REV_COLL_F@YGPA_P2MGR
		WHERE PRT_AT_CODE = #prtAtCode# AND FEE_TP = #chrgeKnd# AND FISCAL_YR = TO_CHAR(SYSDATE, 'YYYY')
		</select>


      <select id="gamNticRequestMngtDAO.selectNticRequestRcvdTp_S" parameterClass="hashMap" resultClass="egovMap">
		SELECT BILL_NO,
				RCVD_TP,
		       RCVD_DT,
		       BILL_PRT_YN
		FROM PAYEOSU.REV_COLL_F@YGPA_P2MGR
		WHERE PRT_AT_CODE = #prtAtCode#
			AND FEE_TP = (SELECT MAX(DECODE(CHRGE_KND, 'A3', '', 'A4', '', 'D1', '', 'D2', '', CHRGE_KND)) CHRGE_KND
									FROM LEV_REQEST_F
									WHERE PRT_AT_CODE=#prtAtCode# AND MNG_YEAR=#mngYear# AND MNG_NO=#mngNo# AND MNG_CNT=#mngCnt# AND NTIC_CNT=#nticCnt#
									GROUP BY PRT_AT_CODE, MNG_YEAR, MNG_NO, MNG_CNT, NTIC_CNT)
			AND FISCAL_YR = (SELECT MAX(ACCNUT_YEAR)
									FROM LEV_REQEST_F
									WHERE PRT_AT_CODE=#prtAtCode# AND MNG_YEAR=#mngYear# AND MNG_NO=#mngNo# AND MNG_CNT=#mngCnt# AND NTIC_CNT=#nticCnt#
									GROUP BY PRT_AT_CODE, MNG_YEAR, MNG_NO, MNG_CNT, NTIC_CNT)
			AND BILL_NO=(SELECT MAX(NTICNO)
									FROM LEV_REQEST_F
									WHERE PRT_AT_CODE=#prtAtCode# AND MNG_YEAR=#mngYear# AND MNG_NO=#mngNo# AND MNG_CNT=#mngCnt# AND NTIC_CNT=#nticCnt#
									GROUP BY PRT_AT_CODE, MNG_YEAR, MNG_NO, MNG_CNT, NTIC_CNT)
		</select>

      <delete id="gamNticRequestMngtDAO.deleteNticRequestRevCollF">
        DELETE FROM PAYEOSU.REV_COLL_F@YGPA_P2MGR P
			WHERE EXISTS (
				SELECT '1' FROM (SELECT PRT_AT_CODE, CHRGE_KND, ACCNUT_YEAR, NTICNO
					FROM LEV_REQEST_F
					WHERE PRT_AT_CODE=#prtAtCode# AND MNG_YEAR=#mngYear# AND MNG_NO=#mngNo# AND MNG_CNT=#mngCnt# AND NTIC_CNT=#nticCnt#
					GROUP BY PRT_AT_CODE, MNG_YEAR, MNG_NO, MNG_CNT, NTIC_CNT) B
				WHERE P.PRT_AT_CODE = B.PRT_AT_CODE
					AND P.FEE_TP = B.CHRGE_KND
					AND P.FISCAL_YR = B.ACCNUT_YEAR
					AND P.BILL_NO=B.NTICNO
					)
    </delete>

    <update id="gamNticRequestMngtDAO.updateLevReqestArrrgAmt" parameterClass="hashMap">
        UPDATE LEV_REQEST_F SET
        	PAY_TMLMT=TO_DATE(#payTmlmt#, 'YYYY-MM-DD'),
      		ARRRG_NO=(SELECT NVL(ARRRG_NO,0)+1 FROM LEV_REQEST_F WHERE PRT_AT_CODE=#prtAtCode#
		      	AND MNG_YEAR=#mngYear#
		      	AND MNG_NO=#mngNo#
		      	AND MNG_CNT=#mngCnt#
		      	AND NTIC_CNT=#nticCnt#),
      		ARRRG_AMT=TO_NUMBER(#arrrgAmt#),
      		ARRRG_TARIFF=TO_NUMBER(#arrrgTariff#)/100,
      		ARRRG_PAY_DATES=TO_NUMBER(#arrrgPayDates#),
      		UPD_USR=#updUsr#,
      		UPDT_DT=SYSDATE
     	WHERE
			PRT_AT_CODE=#prtAtCode#
	      	AND MNG_YEAR=#mngYear#
	      	AND MNG_NO=#mngNo#
	      	AND MNG_CNT=#mngCnt#
	      	AND NTIC_CNT=#nticCnt#
  </update>

    <update id="gamNticRequestMngtDAO.updateLevReqestIssueYn" parameterClass="hashMap">
        UPDATE LEV_REQEST_F SET
      		NHT_ISUE_YN=#nhtIsueYn#,
      		NTICNO=#nticno#,
      		ACCNUT_YEAR=#accnutYear#,
      		NHT_PRINT_YN = #nhtPrintYn#
       <isNotEmpty prepend="," property="payTmlmt">
       		PAY_TMLMT=#payTmlmt#
     	</isNotEmpty>
       <isEqual prepend="," property="nhtIsueYn" compareValue="Y">
       		NTIC_DT=SYSDATE
     	</isEqual>
       <isNotEqual prepend="," property="nhtIsueYn" compareValue="Y">
       		NTIC_DT=''
     	</isNotEqual>
     	WHERE
			PRT_AT_CODE=#prtAtCode#
	      	AND MNG_YEAR=#mngYear#
	      	AND MNG_NO=#mngNo#
	      	AND MNG_CNT=#mngCnt#
	      	AND NTIC_CNT=#nticCnt#
  </update>

  <update id="gamNticRequestMngtDAO.updateLevReqestNhtPrintYn" parameterClass="hashMap">
        UPDATE LEV_REQEST_F SET
      		NHT_PRINT_YN=#nhtPrintYn#
      		WHERE
			PRT_AT_CODE=#prtAtCode#
      	AND MNG_YEAR=#mngYear#
      	AND MNG_NO=#mngNo#
      	AND MNG_CNT=#mngCnt#
      	AND NTIC_CNT=#nticCnt#
      	<!-- AND CHRGE_KND=#chrgeKnd# -->
  </update>

  <update id="gamNticRequestMngtDAO.updateRevCollFBillPrintYn" parameterClass="hashMap">
        UPDATE PAYEOSU.REV_COLL_F@YGPA_P2MGR SET
      		BILL_PRT_YN=#nhtPrintYn#
      		WHERE
	      		PRT_AT_CODE=#prtAtCode#
	      		AND FEE_TP=#chrgeKnd#
	      		AND FISCAL_YR=(SELECT ACCNUT_YEAR FROM LEV_REQEST_F WHERE PRT_AT_CODE=#prtAtCode#
			      	AND MNG_YEAR=#mngYear#
			      	AND MNG_NO=#mngNo#
			      	AND MNG_CNT=#mngCnt#
			      	AND NTIC_CNT=#nticCnt#
			      	AND CHRGE_KND=#chrgeKnd#)
	     		AND BILL_NO=(SELECT NTICNO FROM LEV_REQEST_F WHERE PRT_AT_CODE=#prtAtCode#
			      	AND MNG_YEAR=#mngYear#
			      	AND MNG_NO=#mngNo#
			      	AND MNG_CNT=#mngCnt#
			      	AND NTIC_CNT=#nticCnt#
			      	AND CHRGE_KND=#chrgeKnd#)
  </update>

  <delete id="gamNticRequestMngtDAO.deleteAssetsUsagePdByStats_D" parameterClass="hashMap">
    <![CDATA[
      DELETE FROM USAGE_PD_BY_STATS_F
      WHERE PRT_AT_CODE=#prtAtCode#
        AND MNG_YEAR=#mngYear#
        AND MNG_NO=#mngNo#
        AND MNG_CNT=#mngCnt#
    ]]>
  </delete>

      <insert id="gamNticRequestMngtDAO.insertLevReqestPdByStats">
    <![CDATA[
        INSERT INTO LEV_REQEST_PD_BY_STATS_F (
      NTIC_YEAR,
      NTIC_QU,
      NTIC_MT,
      NTIC_CNT,
      PRT_AT_CODE,
      MNG_YEAR,
      MNG_NO,
      MNG_CNT,
      CHRGE_KND,
      ENTRPSCD,
      ACCNUT_YEAR,
      NTICNO,
      NTIC_DT,
      NTIC_PD_FROM,
      NTIC_PD_TO,
      FEE,
      RDCXPT_FEE,
      DEPTCD,
      REG_USR,
      REGIST_DT,
      UPD_USR,
      UPDT_DT
    )
    SELECT
    TO_CHAR(START_DATE, 'YYYY'),
    DECODE(TO_CHAR(START_DATE, 'MM'),'01','1','02','1','03','1','04','2','05','2','06','2','07','3','08','3', '09','3','4'),
     TO_CHAR(START_DATE, 'MM'),
     LPAD(NTIC_CNT, 2, '0'),
    #prtAtCode#, #mngYear#, #mngNo#, #mngCnt#, FEE_TP, #entrpscd# ENTRPSCD, ACCNUT_YEAR,
    NTICNO,NTIC_DT,NTIC_PD_FROM,NTIC_PD_TO,
    RNTFEE,
    0,
    #deptcd#,
    #regUsr#,
    #registDt#,
    #updUsr#, SYSDATE
    from (
      SELECT A.FEE_TP, NTIC_CNT, DECODE(A.FEE_TP, #chrgeKnd#, RNTFEE, 'A3', TRUNC(REFE*(RATE_DAY)/365*A.RATE, -1)) RNTFEE, REFE, START_DATE, PREV_DUE_DATE, DUE_DATE, END_DATE
      FROM (
      SELECT #chrgeKnd# FEE_TP, 1 RATE FROM dual
      UNION ALL SELECT 'A3', TO_NUMBER(#payinstIntrrate#, '0.0000') FROM dual
      ) A, (
      SELECT ROWNUM                                                                                                                                                     AS NTIC_CNT,
          TRUNC(#fee#                                                                    / (TRUNC(MONTHS_BETWEEN(TO_DATE(#nticPdTo#,'YYYY-MM-DD'), TO_DATE(#nticPdFrom#,'YYYY-MM-DD')) / 1)+1), -1)                          AS RNTFEE,
          TRUNC(#fee#                                                                    - ((#fee#/(TRUNC(MONTHS_BETWEEN(TO_DATE(#nticPdTo#,'YYYY-MM-DD'), TO_DATE(#nticPdFrom#,'YYYY-MM-DD')) / 1)+1)) * (ROWNUM-1)), -1) AS REFE,
          ADD_MONTHS(TO_DATE(#nticPdFrom#,'YYYY-MM-DD'), 1                      * (ROWNUM-1))                                                                                                                                     AS START_DATE,
          DECODE(ROWNUM, 1, 0, ADD_MONTHS(TO_DATE(#nticPdFrom#,'YYYY-MM-DD'), 1 * (ROWNUM-1))-ADD_MONTHS(TO_DATE(#nticPdFrom#,'YYYY-MM-DD'), 1 * (ROWNUM-1)-1))                                                        AS RATE_DAY,
          LAG(ADD_MONTHS(TO_DATE(#nticPdFrom#,'YYYY-MM-DD'), 1                  * (ROWNUM-1))+14) OVER (ORDER BY ROWNUM)                                                                                                          AS PREV_DUE_DATE,
          ADD_MONTHS(TO_DATE(#nticPdFrom#,'YYYY-MM-DD'), 1                      * (ROWNUM-1))+14                                                                                                                                  AS DUE_DATE,
          (
          CASE
            WHEN TO_DATE(#nticPdTo#,'YYYY-MM-DD') < ADD_MONTHS(TO_DATE(#nticPdFrom#,'YYYY-MM-DD'), 1 * ROWNUM) - 1
            THEN TO_DATE(#nticPdTo#,'YYYY-MM-DD')
            ELSE ADD_MONTHS(TO_DATE(#nticPdFrom#,'YYYY-MM-DD'), 1 * ROWNUM) - 1
          END ) AS END_DATE
        FROM COMTCCMMNDETAILCODE
        WHERE ROWNUM <= (TRUNC(MONTHS_BETWEEN(TO_DATE(#nticPdTo#,'YYYY-MM-DD'), TO_DATE(#nticPdFrom#,'YYYY-MM-DD')) / 1)+1)
         ) B
    )
    WHERE RNTFEE<>0
    ]]>

    </insert>

  <delete id="gamNticRequestMngtDAO.deleteLevReqestPdByStats" parameterClass="hashMap">
    <![CDATA[
      DELETE FROM LEV_REQEST_PD_BY_STATS_F
      WHERE PRT_AT_CODE=#prtAtCode#
        AND MNG_YEAR=#mngYear#
        AND MNG_NO=#mngNo#
        AND MNG_CNT=#mngCnt#
    ]]>
  </delete>

</sqlMap>

