<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="rte.ygpa.gam.cmmn.fclty">

  <typeAlias  alias="egovMap" type="egovframework.rte.psl.dataaccess.util.EgovMap"/>
  <typeAlias alias="hashMap" type="java.util.HashMap"/>

  <select id="gamNticRequestMngtDAO.selectLevRequestByPk_S" parameterClass="hashMap" resultClass="egovMap">
    SELECT
      NTIC_CNT,
      PRT_AT_CODE,
      MNG_YEAR,
      MNG_NO,
      MNG_CNT,
      CHRGE_KND,
      FCLTY_SE,
      ENTRPSCD,
      ENTRPS_NM,
      NTIC_PD_FROM,
      NTIC_PD_TO,
      ACCNUT_YEAR,
      NTIC_NO,
      NTIC_DT,
      PAY_TMLMT,
      SANCTN_STTUS,
      SANCTNER_EMPL_NO,
      SANCTN_DT,
      OLNLP,
      FEE,
      VAT_YN,
      VAT,
      NTIC_AMT,
      RM,
      RCIV_SE,
      RCIV_DT,
      NHT_ISUE_YN,
      ARRRG_NO,
      ARRRG_AMT,
      REQEST_SEQ,
      DEPTCD,
      NTIC_MTH,
      NHT_PRINT_YN,
      REG_USR,
      REGIST_DT,
      UPD_USR,
      UPDT_DT
      FROM LEV_REQEST_PD_BY_STATS_F
      WHERE  PRT_AT_CODE=#prtAtCode#
        AND MNG_YEAR=#mngYear#
        AND MNG_NO=#mngNo#
        AND MNG_CNT=#mngCnt#
        AND NTIC_CNT=#nticCnt#
        AND CHRGE_KND=#chrgeKnd#
  </select>

  <select id="gamNticRequestMngtDAO.selectLevRequestList_D" parameterClass="hashMap" resultClass="egovMap">
    SELECT
      NTIC_CNT,
      PRT_AT_CODE,
      MNG_YEAR,
      MNG_NO,
      MNG_CNT,
      CHRGE_KND,
      FCLTY_SE,
      ENTRPSCD,
      ENTRPS_NM,
      NTIC_PD_FROM,
      NTIC_PD_TO,
      ACCNUT_YEAR,
      NTIC_NO,
      NTIC_DT,
      PAY_TMLMT,
      SANCTN_STTUS,
      SANCTNER_EMPL_NO,
      SANCTN_DT,
      OLNLP,
      FEE,
      VAT_YN,
      VAT,
      NTIC_AMT,
      RM,
      RCIV_SE,
      RCIV_DT,
      NHT_ISUE_YN,
      ARRRG_NO,
      ARRRG_AMT,
      REQEST_SEQ,
      DEPTCD,
      NTIC_MTH,
      NHT_PRINT_YN,
      REG_USR,
      REGIST_DT,
      UPD_USR,
      UPDT_DT
      FROM LEV_REQEST_PD_BY_STATS_F
      WHERE  PRT_AT_CODE=#prtAtCode#
        AND MNG_YEAR=#mngYear#
        AND MNG_NO=#mngNo#
        AND MNG_CNT=#mngCnt#
        AND NTIC_CNT=#nticCnt#
        <isNotEmpty prepend="AND" property="chrgeKnd">
          CHRGE_KND=#chrgeKnd#
        </isNotEmpty>
  </select>

    <insert id="gamNticRequestMngtDAO.insertNticRequestRevCollF" parameterClass="hashMap" >
        INSERT INTO REV_COLL_F@YGPA_PORTMIS (
      PRT_AT_CODE, FEE_TP, FISCAL_YR, BILL_NO,
      AGENT_CODE, BZ_RGST_ID, AGENT_NAME, SSN,
      BILL_DT, DUE_DATE, BILL_PRT_YN,
      BILL_AMNT, EXMP_AMNT, OVER_AMNT, DC_AMNT,

      UPDT_UID, UPDT_DATE, FIRST_BILL_DT, VAT_YN, VAT, STR_DATE, END_DATE,
      )

        SELECT
      PRT_AT_CODE, CHRGE_KND FEE_TP, ACCNUT_YEAR FISCAL_YR, NTIC_NO BILL_NO,
      ENTRPSCD, (SELECT BZ_RGST_ID FROM SHP_OWOP_F@P2MGR WHERE AGENT_CODE=ENTRPSCD) BZ_RGST_ID, (SELECT FIRM_KOR_NM FROM SHP_OWOP_F@P2MGR WHERE AGENT_CODE=ENTRPSCD) AGENT_NAME,(SELECT SSN FROM SHP_OWOP_F@P2MGR WHERE AGENT_CODE=ENTRPSCD) SSN,
      SYS_DATE, PAY_TMLMT, NHT_PRINT_YN,
      NTIC_AMT, RDCXPT_FEE, 0, 0,

      #updUsr#, SYSDATE, SYSDATE, VAT_YN, VAT, NTIC_PD_FROM, NTIC_PD_TO
      FROM LEV_REQEST
      WHERE PRT_AT_CODE=#prtAtCode#
      	AND MNG_YEAR=#mngYear#
      	AND MNG_NO=#mngNo#
      	AND MNG_CNT=#mngCnt#
      	AND NTIC_CNT=#nticCnt#
      	AND CHRGE_KND=#chrgeKnd#
    )
    </insert>

      <insert id="gamNticRequestMngtDAO.insertCancelNticRequestRevCollF">
        INSERT INTO REV_COLL_F@YGPA_PORTMIS (
      PRT_AT_CODE, FEE_TP, FISCAL_YR, BILL_NO,
      AGENT_CODE, BZ_RGST_ID, AGENT_NAME, SSN,
      BILL_DT, DUE_DATE, BILL_PRT_YN,
      BILL_AMNT, EXMP_AMNT, OVER_AMNT, DC_AMNT,

      UPDT_UID, UPDT_DATE, FIRST_BILL_DT, VAT_YN, VAT, STR_DATE, END_DATE,
      )

        SELECT
      PRT_AT_CODE, CHRGE_KND FEE_TP, ACCNUT_YEAR FISCAL_YR, NTIC_NO BILL_NO,
      ENTRPSCD, (SELECT BZ_RGST_ID FROM SHP_OWOP_F@P2MGR WHERE AGENT_CODE=ENTRPSCD) BZ_RGST_ID, (SELECT FIRM_KOR_NM FROM SHP_OWOP_F@P2MGR WHERE AGENT_CODE=ENTRPSCD) AGENT_NAME,(SELECT SSN FROM SHP_OWOP_F@P2MGR WHERE AGENT_CODE=ENTRPSCD) SSN,
      SYS_DATE, PAY_TMLMT, NHT_PRINT_YN,
      NTIC_AMT, RDCXPT_FEE, 0, 0,

      #updUsr#, SYSDATE, SYSDATE, VAT_YN, VAT, NTIC_PD_FROM, NTIC_PD_TO
      FROM LEV_REQEST
      WHERE PRT_AT_CODE=#prtAtCode#
      	AND MNG_YEAR=#mngYear#
      	AND MNG_NO=#mngNo#
      	AND MNG_CNT=#mngCnt#
      	AND NTIC_CNT=#nticCnt#
      	AND CHRGE_KND=#chrgeKnd#
    )
    </insert>

    <update id="gamNticRequestMngtDAO.updateLevReqestIssueYn" parameterClass="hashMap">
        UPDATE LEV_REQEST SET
      		NHT_ISUE_YN=#nhtIsueYn#
      		WHERE
			PRT_AT_CODE=#prtAtCode#
      	AND MNG_YEAR=#mngYear#
      	AND MNG_NO=#mngNo#
      	AND MNG_CNT=#mngCnt#
      	AND NTIC_CNT=#nticCnt#
      	AND CHRGE_KND=#chrgeKnd#
  </update>

  <update id="gamNticRequestMngtDAO.updateLevReqestNhtPrintYn" parameterClass="hashMap">
        UPDATE LEV_REQEST SET
      		NHT_PRINT_YN=#nhtPrintYn#
      		WHERE
			PRT_AT_CODE=#prtAtCode#
      	AND MNG_YEAR=#mngYear#
      	AND MNG_NO=#mngNo#
      	AND MNG_CNT=#mngCnt#
      	AND NTIC_CNT=#nticCnt#
      	AND CHRGE_KND=#chrgeKnd#
  </update>

  <delete id="gamAssetsUsePermMngtDao.deleteAssetsUsagePdByStats_D" parameterClass="hashMap">
    <![CDATA[
      DELETE FROM USAGE_PD_BY_STATS_F
      WHERE PRT_AT_CODE=#prtAtCode#
        AND MNG_YEAR=#mngYear#
        AND MNG_NO=#mngNo#
        AND MNG_CNT=#mngCnt#
    ]]>
  </delete>

      <insert id="gamNticRequestMngtDAO.insertLevReqestPdByStats">
    <![CDATA[
        INSERT INTO LEV_REQEST_PD_BY_STATS_F (
      NTIC_YEAR,
      NTIC_QU,
      NTIC_MT,
      NTIC_CNT,
      PRT_AT_CODE,
      MNG_YEAR,
      MNG_NO,
      MNG_CNT,
      CHRGE_KND,
      ENTRPSCD,
      ACCNUT_YEAR,
      NTICNO,
      NTIC_DT,
      NTIC_PD_FROM,
      NTIC_PD_TO,
      FEE,
      RDCXPT_FEE,
      DEPTCD,
      REG_USR,
      REGIST_DT,
      UPD_USR,
      UPDT_DT
    )
    SELECT
    TO_CHAR(START_DATE, 'YYYY'),
    DECODE(TO_CHAR(START_DATE, 'MM'),'01','1','02','1','03','1','04','2','05','2','06','2','07','3','08','3', '09','3','4'),
     TO_CHAR(START_DATE, 'MM'),
     LPAD(NTIC_CNT, 2, '0'),
    #prtAtCode#, #mngYear#, #mngNo#, #mngCnt#, FEE_TP, #entrpscd# ENTRPSCD, ACCNUT_YEAR,
    NTICNO,NTIC_DT,NTIC_PD_FROM,NTIC_PD_TO,
    RNTFEE,
    0,
    #deptcd#,
    #regUsr#,
    #registDt#,
    #updUsr#, SYSDATE
    from (
      SELECT A.FEE_TP, NTIC_CNT, DECODE(A.FEE_TP, #chrgeKnd#, RNTFEE, 'A3', TRUNC(REFE*(RATE_DAY)/365*A.RATE, -1)) RNTFEE, REFE, START_DATE, PREV_DUE_DATE, DUE_DATE, END_DATE
      FROM (
      SELECT #chrgeKnd# FEE_TP, 1 RATE FROM dual
      UNION ALL SELECT 'A3', TO_NUMBER(#payinstIntrrate#, '0.0000') FROM dual
      ) A, (
      SELECT ROWNUM                                                                                                                                                     AS NTIC_CNT,
          TRUNC(#fee#                                                                    / (TRUNC(MONTHS_BETWEEN(TO_DATE(#nticPdTo#,'YYYY-MM-DD'), TO_DATE(#nticPdFrom#,'YYYY-MM-DD')) / 1)+1), -1)                          AS RNTFEE,
          TRUNC(#fee#                                                                    - ((#fee#/(TRUNC(MONTHS_BETWEEN(TO_DATE(#nticPdTo#,'YYYY-MM-DD'), TO_DATE(#nticPdFrom#,'YYYY-MM-DD')) / 1)+1)) * (ROWNUM-1)), -1) AS REFE,
          ADD_MONTHS(TO_DATE(#nticPdFrom#,'YYYY-MM-DD'), 1                      * (ROWNUM-1))                                                                                                                                     AS START_DATE,
          DECODE(ROWNUM, 1, 0, ADD_MONTHS(TO_DATE(#nticPdFrom#,'YYYY-MM-DD'), 1 * (ROWNUM-1))-ADD_MONTHS(TO_DATE(#nticPdFrom#,'YYYY-MM-DD'), 1 * (ROWNUM-1)-1))                                                        AS RATE_DAY,
          LAG(ADD_MONTHS(TO_DATE(#nticPdFrom#,'YYYY-MM-DD'), 1                  * (ROWNUM-1))+14) OVER (ORDER BY ROWNUM)                                                                                                          AS PREV_DUE_DATE,
          ADD_MONTHS(TO_DATE(#nticPdFrom#,'YYYY-MM-DD'), 1                      * (ROWNUM-1))+14                                                                                                                                  AS DUE_DATE,
          (
          CASE
            WHEN TO_DATE(#nticPdTo#,'YYYY-MM-DD') < ADD_MONTHS(TO_DATE(#nticPdFrom#,'YYYY-MM-DD'), 1 * ROWNUM) - 1
            THEN TO_DATE(#nticPdTo#,'YYYY-MM-DD')
            ELSE ADD_MONTHS(TO_DATE(#nticPdFrom#,'YYYY-MM-DD'), 1 * ROWNUM) - 1
          END ) AS END_DATE
        FROM COMTCCMMNDETAILCODE
        WHERE ROWNUM <= (TRUNC(MONTHS_BETWEEN(TO_DATE(#nticPdTo#,'YYYY-MM-DD'), TO_DATE(#nticPdFrom#,'YYYY-MM-DD')) / 1)+1)
         ) B
    )
    WHERE RNTFEE<>0
    ]]>

    </insert>

  <delete id="gamNticRequestMngtDAO.deleteLevReqestPdByStats" parameterClass="hashMap">
    <![CDATA[
      DELETE FROM LEV_REQEST_PD_BY_STATS_F
      WHERE PRT_AT_CODE=#prtAtCode#
        AND MNG_YEAR=#mngYear#
        AND MNG_NO=#mngNo#
        AND MNG_CNT=#mngCnt#
    ]]>
  </delete>

</sqlMap>

