<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">
<sqlMap namespace="ygpa.gam.mngFee">

    <typeAlias alias="egovMap" type="egovframework.rte.psl.dataaccess.util.EgovMap"/>
    <typeAlias alias="hashMap" type="java.util.HashMap"/>
    <typeAlias alias="gamFcltsMngFeeMngVo" type="egovframework.rte.ygpa.gam.mngFee.service.GamFcltsMngFeeMngVo"/>
    <typeAlias alias="gamFcltsMngFeeMngDetailVo" type="egovframework.rte.ygpa.gam.mngFee.service.GamFcltsMngFeeMngDetailVo"/>

    <select id="gamFcltsMngFeeMngDao.selectFcltsMngFeeMngList_D" parameterClass="gamFcltsMngFeeMngVo" resultClass="egovMap">
     SELECT A.*
           FROM (
                   SELECT  ROWNUM RNUM, S.*
                     FROM (
                            SELECT
									MNG_MT,
									SUBSTR(MNG_MT,0,4) AS MT_YEAR,
									SUBSTR(MNG_MT,5,6) AS MT_MON,
									MNG_FEE_JOB_SE,
									MNG_FEE_SJ,
									FCLTY_MNG_FEE,
									ELCTY_FEE,
									WATER_FEE,
									GAS_FEE,
									ENV_FEE,
									MNG_TOTAL_FEE,
									REG_USR,
									UPD_USR,
									TO_CHAR(UPDT_DT, 'YYYY-MM-DD') UPDT_DT,
									TO_CHAR(REGIST_DT, 'YYYY-MM-DD') REGIST_DT,
									TAXT_SE,
									NTIC_MTH,
									PAY_MTH
					        FROM FCLTS_MNG_FEE_F
								  WHERE 1=1
						         <isNotEmpty property="sMngMtYear">
						             AND MNG_MT LIKE '%' || #sMngMtYear# || #sMngMtMon# ||'%'
						         </isNotEmpty>

						         <isNotEmpty property="sMngFeeJobSe">
							         AND MNG_FEE_JOB_SE =  #sMngFeeJobSe#
							     </isNotEmpty>
                             ORDER BY MNG_MT
                ) S
             ) A
        <![CDATA[ WHERE ROWNUM <= #recordCountPerPage# and RNUM > #firstIndex# ]]>
    </select>

    <select id="gamFcltsMngFeeMngDao.selectFcltsMngFeeMngListTotCnt_S" parameterClass="gamFcltsMngFeeMngVo" resultClass="int">
         SELECT COUNT(*) totcnt
              FROM FCLTS_MNG_FEE_F
                           <![CDATA[  WHERE 1=1 ]]>
	         <isNotEmpty property="sMngMtYear">
	             AND MNG_MT LIKE '%' || #sMngMtYear# || #sMngMtMon# ||'%'
	         </isNotEmpty>

	         <isNotEmpty property="sMngFeeJobSe">
		         AND MNG_FEE_JOB_SE =  #sMngFeeJobSe#
		     </isNotEmpty>
    </select>

	<insert id="gamFcltsMngFeeMngDao.insertFcltsMngFeeMng">
		<![CDATA[
		    INSERT
		      INTO  FCLTS_MNG_FEE_F
		         (
		         	 MNG_MT
					,MNG_FEE_JOB_SE
					,MNG_FEE_SJ
					,FCLTY_MNG_FEE
					,ELCTY_FEE
					,WATER_FEE
					,GAS_FEE
					,ENV_FEE
					,MNG_TOTAL_FEE
					,REG_USR
					,REGIST_DT
					,TAXT_SE
					,NTIC_MTH
					,PAY_MTH
		         )
		    VALUES
		         (
		         		#mngMt#
						,#mngFeeJobSe#
						,#mngFeeSj#
						,REPLACE(#fcltyMngFee#,',','')
						,REPLACE(#elctyFee#,',','')
						,REPLACE(#waterFee#,',','')
						,REPLACE(#gasFee#,',','')
						,REPLACE(#envFee#,',','')
						,REPLACE(#mngTotalFee#,',','')
						,#regUsr#
						,sysdate
						,#taxtSe#
						,#nticMth#
						,#payMth#
		         )
		]]>
	</insert>

	<insert id="gamFcltsMngFeeMngDao.insertFcltsMngFeeMngDetail">
		<![CDATA[
		    INSERT
		      INTO  FCLTS_MNG_FEE_DETAIL_F
		         (
		         	 MNG_MT
					,MNG_FEE_JOB_SE
					,ENTRPSCD
					,MNG_FEE
					,ELCTY_FEE
					,WATER_FEE
					,GAS_FEE
					,MNG_TOTAL_FEE
					,REG_USR
					,USAGE_AR
					,REGIST_DT
					,MNG_SEQ
		         )
		    VALUES
		         (
		         		#mngMt#
						,#mngFeeJobSe#
						,REPLACE(#entrpscd#,',','')
						,REPLACE(#mngFee#,',','')
						,REPLACE(#elctyFee#,',','')
						,REPLACE(#waterFee#,',','')
						,REPLACE(#gasFee#,',','')
						,REPLACE(#mngTotalFee#,',','')
						,REPLACE(#regUsr#,',','')
						,REPLACE(#usageAr#,',','')
						,sysdate
						,(SELECT LPAD(NVL(MAX(MNG_SEQ), 0) + 1, 3, '0') FROM FCLTS_MNG_FEE_DETAIL_F)
		         )
		]]>
	</insert>

	<update id="gamFcltsMngFeeMngDao.updateFcltsMngFeeMng">
		<![CDATA[
            UPDATE FCLTS_MNG_FEE_F SET
					 MNG_FEE_SJ         =	#mngFeeSj#
					,FCLTY_MNG_FEE      =	REPLACE(#fcltyMngFee#,',','')
					,ELCTY_FEE          =	REPLACE(#elctyFee#,',','')
					,WATER_FEE          =	REPLACE(#waterFee#,',','')
					,GAS_FEE            =	REPLACE(#gasFee#,',','')
					,ENV_FEE            =	REPLACE(#envFee#,',','')
					,MNG_TOTAL_FEE      =	REPLACE(#mngTotalFee#,',','')
					,UPD_USR            =	#updUsr#
					,UPDT_DT            =	sysdate
					,TAXT_SE			=	#taxtSe#
					,NTIC_MTH			=	#nticMth#
					,PAY_MTH			=	#payMth#
					WHERE   MNG_MT     		 = #mngMt#
					AND		MNG_FEE_JOB_SE	 = #mngFeeJobSe#
		]]>
	</update>

	<update id="gamFcltsMngFeeMngDao.updateFcltsMngFeeMngDetail">
		<![CDATA[
            UPDATE FCLTS_MNG_FEE_DETAIL_F SET
					 MNG_FEE        	 =	REPLACE(#mngFee#,',','')
					,ELCTY_FEE          =	REPLACE(#elctyFee#,',','')
					,WATER_FEE          =	REPLACE(#waterFee#,',','')
					,GAS_FEE            =	REPLACE(#gasFee#,',','')
					,MNG_TOTAL_FEE      =	REPLACE(#mngTotalFee#,',','')
					,USAGE_AR    		=	REPLACE(#usageAr#,',','')
					,UPD_USR            =	#updUsr#
					,UPDT_DT            =	sysdate
					WHERE   MNG_MT     		 = #mngMt#
					AND		MNG_FEE_JOB_SE	 = #mngFeeJobSe#
					AND		MNG_SEQ	 	 = #mngSeq#
		]]>
	</update>

	<delete id="gamFcltsMngFeeMngDao.deleteFcltsMngFeeMngDetail">
		<![CDATA[
            DELETE  FCLTS_MNG_FEE_DETAIL_F
         		    WHERE   MNG_MT     		 = #mngMt#
					AND		MNG_FEE_JOB_SE	 = #mngFeeJobSe#
					AND		MNG_SEQ	 	 = #mngSeq#
		]]>
	</delete>

	<select id="gamFcltsMngFeeMngDao.selectFcltsMngFeeMngDetailList_D" parameterClass="gamFcltsMngFeeMngDetailVo" resultClass="egovMap">
                           SELECT
									 MNG_MT
									,MNG_FEE_JOB_SE
									,ENTRPSCD
									,(SELECT
											ENTRPS_NM
									FROM ENTRPS_INFO_F B
  											WHERE A.ENTRPSCD= B.ENTRPSCD) AS ENTRPS_NM
									,MNG_FEE
									,ELCTY_FEE
									,WATER_FEE
									,GAS_FEE
									,MNG_TOTAL_FEE
									,REG_USR
									,USAGE_AR
									,TO_CHAR(REGIST_DT, 'YYYY-MM-DD') REGIST_DT
									,MNG_SEQ
					        FROM FCLTS_MNG_FEE_DETAIL_F A
								  WHERE 1=1
						         <isNotEmpty property="mngMt">
						         <![CDATA[AND MNG_MT = #mngMt#]]>
						         </isNotEmpty>

						         <isNotEmpty property="mngFeeJobSe">
							       <![CDATA[AND MNG_FEE_JOB_SE =  #mngFeeJobSe#]]>
							     </isNotEmpty>
                             ORDER BY REGIST_DT
    </select>

	<delete id="gamFcltsMngFeeMngDao.deleteFcltsMngFeeMng">
		<![CDATA[
            DELETE  FCLTS_MNG_FEE_F
         		    WHERE   MNG_MT     		 = #mngMt#
					AND		MNG_FEE_JOB_SE	 = #mngFeeJobSe#
		]]>
	</delete>

	<select id="gamFcltsMngFeeMngDao.selectChargeKndList" resultClass="egovMap">
            		<![CDATA[
			SELECT
			CODE_ID, CODE, CODE_NM, CODE_DC
			FROM
			COMTCCMMNDETAILCODE
			WHERE
			USE_AT      = 'Y'
			AND CODE_ID = 'GAM024'
				AND CODE NOT IN ('A3', 'A4', 'UG', 'DA')
			ORDER BY CODE, CODE_NM
		]]>
    </select>

	<select id="gamFcltsMngFeeMngDao.selectFcltsMngFeeMngPk" parameterClass="hashMap" resultClass="egovMap">
						SELECT
									 MNG_MT
									,MNG_FEE_JOB_SE
									,MNG_SEQ
									,ENTRPSCD
									,(SELECT
											ENTRPS_NM
									FROM ENTRPS_INFO_F B
  											WHERE A.ENTRPSCD= B.ENTRPSCD) AS ENTRPS_NM
									,MNG_FEE
									,ELCTY_FEE
									,WATER_FEE
									,GAS_FEE
									,MNG_TOTAL_FEE
									,REG_USR
									,USAGE_AR
									,TO_CHAR(REGIST_DT, 'YYYY-MM-DD') REGIST_DT
					        FROM FCLTS_MNG_FEE_DETAIL_F A
								  WHERE 1=1
						         AND MNG_MT = #mngMt#
							     AND MNG_FEE_JOB_SE =  #mngFeeJobSe#
							     AND MNG_SEQ	 	=  #mngSeq#
    </select>

	<insert id="gamFcltsMngFeeMngDao.insertBillCreateOnce">
		<![CDATA[
		    INSERT INTO MNG_FEE_LEV_REQEST_F (
				MNG_MT,MNG_FEE_JOB_SE,MNG_SEQ,REQEST_SEQ,ENTRPSCD,PRT_AT_CODE,CHRGE_KND,ACCNUT_YEAR,NTIC_NO,NTIC_DT,PAY_TMLMT,FEE,VAT_YN,VAT,
		        NTIC_AMT,RM,RCIV_SE,RCIV_DT,NHT_ISUE_YN,ARRRG_NO,ARRRG_AMT,DEPT_CD,NTIC_MTH,SANCTN_STTUS,SANCTNER_EMPL_NO,SANCTN_DT,NHT_OUTPUT_YN,
		        ARRRG_TARIFF,ARRRG_PAY_DATES,ADIT_NTIC_YN,SETOFF_YN,REG_USR,REGIST_DT
		        )values(
			         #mngMt#
			        ,#mngFeeJobSe#
			        ,#mngSeq#
			        ,'000'
			        ,#entrpscd#
			        ,'640'
			        ,#chrgeKnd#
			        ,null
			        ,(SELECT MAX(NVL(NTIC_NO,0))+1 FROM MNG_FEE_LEV_REQEST_F
			        												WHERE MNG_MT= #mngMt#
			        												AND MNG_FEE_JOB_SE = #mngFeeJobSe#
			        												AND MNG_SEQ = #mngSeq#
			        												AND ENTRPSCD = #entrpscd#
			         )
			        ,null
			        ,null
			        ,#mngTotalFee#
			        ,'2'
			        ,TRUNC(#mngTotalFee#/10, -1)
			        ,#mngTotalFee#+TRUNC(#mngTotalFee#/10, -1)
			        ,null
			        ,null
			        ,null
			        ,'N'
			        ,null
			        ,null
			        ,#deptcd#
			        ,'1'
			        ,null
			        ,null
			        ,null
			        ,'N'
			        ,null
			        ,null
			        ,null
			        ,null
			        ,#regUsr#
			        ,sysdate)
		]]>
	</insert>


		<select id="gamFcltsMngFeeMngDao.selectNticNoAccnutYear" parameterClass="hashMap" resultClass="egovMap">
		SELECT LPAD(NVL(MAX(BILL_NO), 0) + 1, 6, '0') NTICNO,
		       TO_CHAR(SYSDATE, 'YYYY') ACCNUT_YEAR
		FROM REV_COLL_F
		WHERE <!--  PRT_AT_CODE = #prtAtCode# AND 여기 확인--> FEE_TP = GAM_GET_FEE_TP(#chrgeKnd#) AND FISCAL_YR = TO_CHAR(SYSDATE, 'YYYY')
		</select>

	<select id="gamFcltsMngFeeMngDao.selectReimNticNoAccnutYear" parameterClass="hashMap" resultClass="egovMap">
		SELECT LPAD(NVL(MAX(REIM_BILL_NO), 0) + 1, 6, '0') REIM_FEE_NTICNO,
		       TO_CHAR(SYSDATE, 'YYYY') ACCNUT_YEAR
		FROM REV_COLL_F
		WHERE <!-- PRT_AT_CODE = #prtAtCode# AND FEE_TP = GAM_GET_FEE_TP(#reimChrgeKnd#) AND 여기 확인--> FISCAL_YR = TO_CHAR(SYSDATE, 'YYYY')
		</select>


	<update id="gamFcltsMngFeeMngDao.updateLevReqestIssueYn" parameterClass="hashMap">
        UPDATE LEV_REQEST_F SET
      		NHT_ISUE_YN=#nhtIsueYn#,
      		NTICNO=#nticno#,
      		ACCNUT_YEAR=#accnutYear#,
      		NHT_PRINT_YN = #nhtPrintYn#
       <isNotEmpty prepend="," property="payTmlmt">
       		PAY_TMLMT=#payTmlmt#
     	</isNotEmpty>
       <isEqual prepend="," property="nhtIsueYn" compareValue="Y">
       		NTIC_DT=SYSDATE
     	</isEqual>
       <isNotEqual prepend="," property="nhtIsueYn" compareValue="Y">
       		NTIC_DT=''
     	</isNotEqual>
     	WHERE
			PRT_AT_CODE=#prtAtCode#
	      	AND MNG_YEAR=#mngYear#
	      	AND MNG_NO=#mngNo#
	      	AND MNG_CNT=#mngCnt#
	      	AND NTIC_CNT=#nticCnt#
	      	AND CHRGE_KND=#chrgeKnd#
  	</update>


	<insert id="gamFcltsMngFeeMngDao.insertNticRequestRevCollF" parameterClass="hashMap" >
        INSERT INTO REV_COLL_F (
      PRT_AT_CODE,
      FEE_TP,
      WORK_CODE,
      FISCAL_YR, BILL_NO,
      AGENT_CODE, BZ_RGST_ID, AGENT_NAME, SSN,
      BILL_DT, DUE_DATE, BILL_PRT_YN,
      BILL_AMNT, EXMP_AMNT, OVER_AMNT, DC_AMNT,
		RCVD_TP,
      UPDT_UID, UPDT_DATE, FIRST_BILL_DT, VAT_YN, VAT, STR_DATE, END_DATE,
      DEPT,USER_NAME
      , REIM_FEE, REIM_BILL_NO, REIM_WORK_CODE, REIM_FEE_TP
      )
        SELECT
      L.PRT_AT_CODE,
      GAM_GET_FEE_TP(#chrgeKnd#) FEE_TP,
      GAM_GET_WORK_CODE(#prtAtCode#, #mngYear#, #mngNo#, #mngCnt#, #nticCnt#, #chrgeKnd#)  WORK_CODE,
      #accnutYear# FISCAL_YR, #nticno# BILL_NO,
      L.ENTRPSCD,
      (SELECT BIZRNO FROM ENTRPS_INFO_F E WHERE L.ENTRPSCD=ENTRPSCD) BZ_RGST_ID,
      (SELECT ENTRPS_NM FROM ENTRPS_INFO_F E WHERE L.ENTRPSCD=ENTRPSCD) AGENT_NAME,
      '' SSN,
      SYSDATE,
      <isNotEmpty property="payTmlmt">
	      TO_DATE(#payTmlmt#, 'YYYY-MM-DD'),
      </isNotEmpty>
      <isEmpty property="payTmlmt">
	      TRUNC(SYSDATE+15),
      </isEmpty>
       L.NHT_PRINT_YN,
      L.FEE, L.RDCXPT_FEE, 0, 0,
		'0',
      #updUsr#, SYSDATE, SYSDATE, L.VAT_YN, L.VAT, L.NTIC_PD_FROM, L.NTIC_PD_TO,
      #deptCd#,
      #userName#
      , L.REIM_FEE
      , case when L.REIM_FEE>0 then #reimFeeNticno# else '' end
      , case when L.REIM_FEE>0 then L.REIM_CHRGE_KND else '' end
      , case when L.REIM_FEE>0 then 'V4' else '' end
      FROM LEV_REQEST_F L
      WHERE PRT_AT_CODE=#prtAtCode#
      	AND MNG_YEAR=#mngYear#
      	AND MNG_NO=#mngNo#
      	AND MNG_CNT=#mngCnt#
      	AND NTIC_CNT=#nticCnt#
      	AND CHRGE_KND=#chrgeKnd#
    </insert>

   </sqlMap>