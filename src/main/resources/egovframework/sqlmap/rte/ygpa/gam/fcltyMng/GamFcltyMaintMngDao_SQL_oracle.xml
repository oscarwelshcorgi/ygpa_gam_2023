<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd" >
<sqlMap namespace="ygpa.gam.fcltyMng">

    <typeAlias alias="egovMap" type="egovframework.rte.psl.dataaccess.util.EgovMap"/>
    <typeAlias alias="hashMap" type="java.util.HashMap"/>
    <typeAlias alias="gamFcltyMaintMngVO" type="egovframework.rte.ygpa.gam.fcltyMng.service.GamFcltyMaintMngVO"/>
    
    <!-- 유지보수내역 -->
	<select id="gamFcltyMaintMngDao.selectFcltyMaintMngList_D" parameterClass="gamFcltyMaintMngVO" resultClass="egovMap">
        SELECT A.*
           FROM (
                SELECT ROWNUM RNUM, S.*
                	FROM (
						SELECT
							M.MNTN_RPR_CNST_NM
							, M.PLANNER_NM
							, M.CNST_CHARG_NM
							, TO_CHAR(M.MNTN_RPR_CNST_START_DT,'YYYY-MM-DD') MNTN_RPR_CNST_START_DT
							, TO_CHAR(M.MNTN_RPR_CNST_END_DT,'YYYY-MM-DD') MNTN_RPR_CNST_END_DT
							, M.MNTN_RPR_CNST_AMT
							, M.RM
							, M.REG_USR
							, M.REGIST_DT
							, M.UPD_USR
							, M.UPDT_DT
							, M.CTRT_NO
							, (SELECT I.CTRT_NM FROM CTRT_INFO_F I WHERE I.CTRT_NO = M.CTRT_NO) CTRT_NM
							, M.FCLTS_JOB_SE
							, M.FCLTS_MNG_GROUP_NO
							, (SELECT G.FCLTS_MNG_GROUP_NM FROM FCLTS_MNG_GROUP_F G WHERE G.FCLTS_MNG_GROUP_NO = M.FCLTS_MNG_GROUP_NO) FCLTS_MNG_GROUP_NM
							, M.MNTN_RPR_SEQ
							, M.MNTN_RPR_SE
							, GAM_GET_MNTN_RPR_SE_NM(M.MNTN_RPR_SE) MNTN_RPR_SE_NM
							, M.MNTN_RPR_PART
							, M.MNTN_RPR_CN
							, M.MNTN_RPR_BDGT
							, M.CNSTRTR
							, M.RESPON_ENGINEER
							, M.ENFORCE_YEAR
						FROM
							MNTN_RPR_DTLS_F M 
						WHERE
							1 = 1 
							
						<isNotEmpty property="sFcltsMngGroupNo">
	           				AND M.FCLTS_MNG_GROUP_NO = #sFcltsMngGroupNo#
	           			</isNotEmpty>
	           			
	           			<isNotEmpty property="sCtrtNo">
	           				AND M.CTRT_NO = #sCtrtNo#
	           			</isNotEmpty>
							
						<isNotEmpty property="sFcltsJobSe">
	           				AND M.FCLTS_JOB_SE = #sFcltsJobSe#
	           			</isNotEmpty>
	           			
	           			<isNotEmpty property="sMntnRprCnstNm">
	           				AND M.MNTN_RPR_CNST_NM LIKE '%' || #sMntnRprCnstNm# || '%'
	           			</isNotEmpty>
	           			
	           			<isNotEmpty property="sMntnRprSe">
	           				AND M.MNTN_RPR_SE = #sMntnRprSe#
	           			</isNotEmpty>
	           			
	           			<isNotEmpty property="sMntnRprCnstStartDtFr">
	           				AND 
	           				(
	           					<![CDATA[ M.MNTN_RPR_CNST_START_DT >= #sMntnRprCnstStartDtFr# ]]>
	           				<isNotEmpty property="sMntnRprCnstStartDtTo">
		           				<![CDATA[ AND M.MNTN_RPR_CNST_START_DT <= #sMntnRprCnstStartDtTo# ]]>
		           			</isNotEmpty>
		           			)
	           			</isNotEmpty>
	           			
						ORDER BY
							M.MNTN_RPR_CNST_START_DT DESC
                ) S
             ) A
        <![CDATA[ WHERE ROWNUM <= #recordCountPerPage# and RNUM > #firstIndex# ]]>		
	</select>

	<select id="gamFcltyMaintMngDao.selectFcltyMaintMngListTotCnt_S" parameterClass="gamFcltyMaintMngVO" resultClass="int">
		SELECT
			COUNT(*) TOT_CNT
		FROM
			MNTN_RPR_DTLS_F M 
		WHERE
			1 = 1 
			
		<isNotEmpty property="sFcltsMngGroupNo">
			AND M.FCLTS_MNG_GROUP_NO = #sFcltsMngGroupNo#
		</isNotEmpty>
		
		<isNotEmpty property="sCtrtNo">
			AND M.CTRT_NO = #sCtrtNo#
		</isNotEmpty>
			
		<isNotEmpty property="sFcltsJobSe">
			AND M.FCLTS_JOB_SE = #sFcltsJobSe#
		</isNotEmpty>
		        			
		<isNotEmpty property="sMntnRprCnstNm">
			AND M.MNTN_RPR_CNST_NM LIKE '%' || #sMntnRprCnstNm# || '%'
		</isNotEmpty>
		        			
		<isNotEmpty property="sMntnRprSe">
			AND M.MNTN_RPR_SE = #sMntnRprSe#
		</isNotEmpty>
		        			
		<isNotEmpty property="sMntnRprCnstStartDtFr">
			AND 
			(
				<![CDATA[ M.MNTN_RPR_CNST_START_DT >= #sMntnRprCnstStartDtFr# ]]>
			<isNotEmpty property="sMntnRprCnstStartDtTo">
				<![CDATA[ AND M.MNTN_RPR_CNST_START_DT <= #sMntnRprCnstStartDtTo# ]]>
			</isNotEmpty>
			)
		</isNotEmpty>
		
	</select>
	
	
	<select id="gamFcltyMaintMngDao.selectFcltyMaintMngDetail_S" parameterClass="gamFcltyMaintMngVO" resultClass="egovMap">
		SELECT
			M.MNTN_RPR_CNST_NM
			, M.PLANNER_NM
			, M.CNST_CHARG_NM
			, TO_CHAR(M.MNTN_RPR_CNST_START_DT,'YYYY-MM-DD') MNTN_RPR_CNST_START_DT
			, TO_CHAR(M.MNTN_RPR_CNST_END_DT,'YYYY-MM-DD') MNTN_RPR_CNST_END_DT
			, M.MNTN_RPR_CNST_AMT
			, M.RM
			, M.REG_USR
			, M.REGIST_DT
			, M.UPD_USR
			, M.UPDT_DT
			, M.CTRT_NO
			, (SELECT I.CTRT_NM FROM CTRT_INFO_F I WHERE I.CTRT_NO = M.CTRT_NO) CTRT_NM
			, M.FCLTS_JOB_SE
			, M.FCLTS_MNG_GROUP_NO
			, (SELECT G.FCLTS_MNG_GROUP_NM FROM FCLTS_MNG_GROUP_F G WHERE G.FCLTS_MNG_GROUP_NO = M.FCLTS_MNG_GROUP_NO) FCLTS_MNG_GROUP_NO_NM
			, M.MNTN_RPR_SEQ
			, M.MNTN_RPR_SE
			, M.MNTN_RPR_PART
			, M.MNTN_RPR_CN
			, M.MNTN_RPR_BDGT
			, M.CNSTRTR
			, M.RESPON_ENGINEER
			, M.ENFORCE_YEAR
		FROM
			MNTN_RPR_DTLS_F M 
		WHERE 
			M.FCLTS_JOB_SE = #fcltsJobSe#
			AND M.FCLTS_MNG_GROUP_NO = #fcltsMngGroupNo#
			AND M.MNTN_RPR_SEQ = TO_NUMBER(#mntnRprSeq#)
	</select>
	
	
	<!-- 유지보수대상시설물내역 -->
	<select id="gamFcltyMaintMngDao.selectMntnRprObjFcltsFList_D" parameterClass="gamFcltyMaintMngVO" resultClass="egovMap">

		SELECT  
			G.FCLTS_MNG_NO
			, G.PRT_FCLTY_NM
			, DECODE(O.FCLTS_MNG_NO,NULL,'','TRUE') CHK_ROLE 
		FROM
			GIS_PRT_FCLTY_CD_F G 
        LEFT OUTER JOIN 
			MNTN_RPR_OBJ_FCLTS_F O 
        ON 
			O.FCLTS_MNG_GROUP_NO = G.FCLTS_MNG_GROUP_NO 
			AND O.FCLTS_MNG_NO = G.FCLTS_MNG_NO 
			AND O.MNTN_RPR_SEQ = TO_NUMBER(#mntnRprSeq#)  
		WHERE 
			<![CDATA[ 1<>1 ]]>

		OR (
		<isNotEmpty property="fcltsJobSe">
			G.PRT_FCLTY_SE = #fcltsJobSe#
			<isNotEmpty property="fcltsMngGroupNo">
				AND 
			</isNotEmpty>
		</isNotEmpty>
		<isNotEmpty property="fcltsMngGroupNo">
			G.FCLTS_MNG_GROUP_NO = #fcltsMngGroupNo#
		</isNotEmpty>
			)
        ORDER BY 
          	O.FCLTS_MNG_NO ASC, G.PRT_FCLTY_NM ASC
          	
	</select>
	
	
	
	<!-- 유지보수첨부파일내역 -->
	<select id="gamFcltyMaintMngDao.selectFcltyMaintFileList_D" parameterClass="gamFcltyMaintMngVO" resultClass="egovMap">
        SELECT
			FCLTS_JOB_SE
			, FCLTS_MNG_GROUP_NO
			, MNTN_RPR_SEQ
			, ATCH_FILE_SEQ
			, ATCH_FILE_SE
			, GAM_GET_FILE_SE_NM(ATCH_FILE_SE) AS ATCH_FILE_SE_NM
			, ATCH_FILE_SJ
			, ATCH_FILE_NM_LOGIC
			, ATCH_FILE_NM_PHYSICL
			, TO_CHAR(ATCH_FILE_WRITNG_DT,'YYYY-MM-DD') ATCH_FILE_WRITNG_DT
			, REG_USR
			, REGIST_DT
			, UPD_USR
			, UPDT_DT
		FROM
			MNTN_RPR_ATCH_FILE_F 
		WHERE
			FCLTS_JOB_SE = #fcltsJobSe#
			AND FCLTS_MNG_GROUP_NO = #fcltsMngGroupNo#
			AND MNTN_RPR_SEQ = TO_NUMBER(#mntnRprSeq#)
        			
		ORDER BY
			MNTN_RPR_SEQ ASC
	</select>

	
	<!-- 유지보수순번 -->
	<select id="gamFcltyMaintMngDao.selectNextMntnRprSeq_S" parameterClass="hashMap" resultClass="int">
		SELECT
			(NVL(MAX(MNTN_RPR_SEQ),0) + 1) NEXT_MNTN_RPR_SEQ
		FROM
			MNTN_RPR_DTLS_F 
		WHERE 
			FCLTS_JOB_SE = #fcltsJobSe#
			AND FCLTS_MNG_GROUP_NO = #fcltsMngGroupNo#
	</select>
	
	
	<!-- 유지보수내역입력 -->
	<insert id="gamFcltyMaintMngDao.insertFcltyMaintMng">
		INSERT INTO 
			MNTN_RPR_DTLS_F 
			(
				MNTN_RPR_CNST_NM
				, PLANNER_NM
				, CNST_CHARG_NM
				, MNTN_RPR_CNST_START_DT
				, MNTN_RPR_CNST_END_DT
				, MNTN_RPR_CNST_AMT
				, RM
				, CTRT_NO
				, FCLTS_JOB_SE
				, FCLTS_MNG_GROUP_NO
				, MNTN_RPR_SEQ
				, MNTN_RPR_SE
				, MNTN_RPR_PART
				, MNTN_RPR_CN
				, MNTN_RPR_BDGT
				, CNSTRTR
				, RESPON_ENGINEER
				, ENFORCE_YEAR
				, REG_USR
				, REGIST_DT
			) 
			VALUES 
			(
				#mntnRprCnstNm#
				, #plannerNm#
				, #cnstChargNm#
				, #mntnRprCnstStartDt#
				, #mntnRprCnstEndDt#
				, TO_NUMBER(#mntnRprCnstAmt#)
				, #rm#
				, #ctrtNo#
				, #fcltsJobSe#
				, #fcltsMngGroupNo#
				, #mntnRprSeq#
				, #mntnRprSe#
				, #mntnRprPart#
				, #mntnRprCn#
				, TO_NUMBER(#mntnRprBdgt#)
				, #cnstrtr#
				, #responEngineer#
				, #enforceYear#
				, #regUsr#
				, SYSDATE
			)
	</insert>
	
	<!-- 유지보수내역수정 -->
	<update id="gamFcltyMaintMngDao.updateFcltyMaintMng">
		UPDATE MNTN_RPR_DTLS_F 
			SET
				MNTN_RPR_CNST_NM = #mntnRprCnstNm#
				, PLANNER_NM = #plannerNm#
				, CNST_CHARG_NM = #cnstChargNm#
				, MNTN_RPR_CNST_START_DT = #mntnRprCnstStartDt#
				, MNTN_RPR_CNST_END_DT = #mntnRprCnstEndDt#
				, MNTN_RPR_CNST_AMT = TO_NUMBER(#mntnRprCnstAmt#)
				, RM = #rm#
				, CTRT_NO = #ctrtNo#
				, MNTN_RPR_SE = #mntnRprSe#
				, MNTN_RPR_PART = #mntnRprPart#
				, MNTN_RPR_CN = #mntnRprCn#
				, MNTN_RPR_BDGT = TO_NUMBER(#mntnRprBdgt#)
				, CNSTRTR = #cnstrtr#
				, RESPON_ENGINEER = #responEngineer#
				, ENFORCE_YEAR = #enforceYear#
				, UPD_USR = #updUsr#
				, UPDT_DT = SYSDATE 
			WHERE 
				FCLTS_JOB_SE = #fcltsJobSe#
				AND FCLTS_MNG_GROUP_NO = #fcltsMngGroupNo#
				AND MNTN_RPR_SEQ = TO_NUMBER(#mntnRprSeq#)
	</update>
	
	<!-- 유지보수내역삭제 -->
	<delete id="gamFcltyMaintMngDao.deleteFcltyMaintMng">
		DELETE FROM 
			MNTN_RPR_DTLS_F 
		WHERE 
			FCLTS_JOB_SE = #fcltsJobSe#
			AND FCLTS_MNG_GROUP_NO = #fcltsMngGroupNo#
			AND MNTN_RPR_SEQ = TO_NUMBER(#mntnRprSeq#)
	</delete>
	
	
	<!-- 유지보수대상시설물입력 -->
	<insert id="gamFcltyMaintMngDao.insertMntnRprObjFcltsF">
		INSERT INTO 
			MNTN_RPR_OBJ_FCLTS_F 
			(
				FCLTS_JOB_SE
				, FCLTS_MNG_GROUP_NO
				, MNTN_RPR_SEQ
				, MNTN_RPR_CNST_MTH
				, UNIT
				, QY
				, PRICE
				, MNTN_RPR_CNST_AMT
				, RM
				, FCLTS_MNG_NO
				, REG_USR
				, REGIST_DT
			) 
			VALUES 
			(
				#fcltsJobSe#
				, #fcltsMngGroupNo#
				, #mntnRprSeq#
				, #mntnRprCnstMth#
				, #unit#
				, TO_NUMBER(#qy#)
				, TO_NUMBER(#price#)
				, TO_NUMBER(#objMntnRprCnstAmt#)
				, #objRm#
				, #fcltsMngNo#
				, #regUsr#
				, SYSDATE
			)
	</insert>
	
	
	<!-- 유지보수대상시설물삭제 -->
	<delete id="gamFcltyMaintMngDao.deleteMntnRprObjFcltsF">
		DELETE FROM  
			MNTN_RPR_OBJ_FCLTS_F 
		WHERE 
			FCLTS_JOB_SE = #fcltsJobSe#
			AND FCLTS_MNG_GROUP_NO = #fcltsMngGroupNo#
			AND MNTN_RPR_SEQ = TO_NUMBER(#mntnRprSeq#)
		<isNotEmpty property="fcltsMngNo">
			AND FCLTS_MNG_NO = #fcltsMngNo#
		</isNotEmpty>
			
	</delete>

	
	
	<!-- 유지보수첨부파일입력 -->
	<insert id="gamFcltyMaintMngDao.insertFcltyMaintFile">
		<selectKey keyProperty="maxAtchFileSeq" resultClass="String">
	       	SELECT 
	       		(NVL(MAX(ATCH_FILE_SEQ),0) + 1)
			FROM 
				MNTN_RPR_ATCH_FILE_F
			WHERE 
				FCLTS_JOB_SE = #fcltsJobSe#
				AND FCLTS_MNG_GROUP_NO = #fcltsMngGroupNo#
				AND MNTN_RPR_SEQ = TO_NUMBER(#mntnRprSeq#)
	    </selectKey>
	    
		INSERT INTO 
			MNTN_RPR_ATCH_FILE_F 
			(
				FCLTS_JOB_SE
				, FCLTS_MNG_GROUP_NO
				, MNTN_RPR_SEQ
				, ATCH_FILE_SEQ
				, ATCH_FILE_SE
				, ATCH_FILE_SJ
				, ATCH_FILE_NM_LOGIC
				, ATCH_FILE_NM_PHYSICL
				, ATCH_FILE_WRITNG_DT
				, REG_USR
				, REGIST_DT
			) 
			VALUES 
			(
				#fcltsJobSe#
				, #fcltsMngGroupNo#
				, #mntnRprSeq#
				, #maxAtchFileSeq#
				, #atchFileSe#
				, #atchFileSj#
				, #atchFileNmLogic#
				, #atchFileNmPhysicl#
				, #atchFileWritngDt#
				, #regUsr#
				, SYSDATE
			)
	</insert>

	
	<!-- 유지보수첨부파일삭제 -->
	<delete id="gamFcltyMaintMngDao.deleteFcltyMaintFile">
		DELETE FROM
			MNTN_RPR_ATCH_FILE_F 
		WHERE 
			FCLTS_JOB_SE = #fcltsJobSe#
			AND FCLTS_MNG_GROUP_NO = #fcltsMngGroupNo#
			AND MNTN_RPR_SEQ = TO_NUMBER(#mntnRprSeq#)
		<isNotEmpty property="atchFileSeq">
			AND ATCH_FILE_SEQ = TO_NUMBER(#atchFileSeq#)
		</isNotEmpty>
			
	</delete>

</sqlMap>